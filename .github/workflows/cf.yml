name: Deploy to Cloudflare Workers

on:
  workflow_dispatch:
  push:
    tags: [ 'v*' ]
    
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Install wrangler
        run: |
          npm install -g wrangler
      - name: Update environments
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # å®šä¹‰éœ€è¦æ£€æŸ¥çš„å¯†é’¥åˆ—è¡¨
          SECRET_NAMES=("PASSWORD" "PREFIX")
          
          # æ£€æŸ¥Workerä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„secretå˜é‡
          set +e
          SECRET_LIST_OUTPUT=$(npx wrangler secret list 2>&1)
          set -e

          # éå†æ£€æŸ¥æ¯ä¸ªå¯†é’¥
          for SECRET_NAME in "${SECRET_NAMES[@]}"; do
            if echo "$SECRET_LIST_OUTPUT" | grep -q "$SECRET_NAME"; then
              echo "âœ… Workerä¸­å·²å­˜åœ¨${SECRET_NAME}(ä½œä¸ºsecretå˜é‡)"
              declare "WORKER_HAS_${SECRET_NAME}"=true
            else
              echo "âš ï¸ Workerä¸­æœªæ£€æµ‹åˆ°${SECRET_NAME}(ä½œä¸ºsecretå˜é‡)"
              declare "WORKER_HAS_${SECRET_NAME}"=false
            fi
          done

          # å¤„ç†æ¯ä¸ªå¯†é’¥
          for SECRET_NAME in "${SECRET_NAMES[@]}"; do
            # åŠ¨æ€è·å–å˜é‡å
            HAS_SECRET_VAR="WORKER_HAS_${SECRET_NAME}"
            WORKER_HAS_SECRET="${!HAS_SECRET_VAR}"
            
            echo "--- å¤„ç† ${SECRET_NAME} ---"
            
            # å¦‚æœWorkerä¸­å·²æœ‰å¯†é’¥ï¼Œåˆ™è·³è¿‡åˆ›å»º
            if [[ "$WORKER_HAS_SECRET" == "true" ]]; then
              echo "âœ… Workerä¸­å·²å­˜åœ¨${SECRET_NAME}(ä½œä¸ºsecretå˜é‡)ï¼Œè·³è¿‡åˆ›å»ºæ­¥éª¤"
            else
              
              if [[ "$SECRET_NAME" == "PASSWORD" ]]; then
                if [[ -n "${{ secrets.PASSWORD }}" ]]; then
                  echo "ä½¿ç”¨GitHubä¸­é…ç½®çš„PASSWORDå€¼"
                  SECRET_VALUE="${{ secrets.PASSWORD }}"
                else
                  echo "âŒ æœªæ‰¾åˆ°GitHubä¸­é…ç½®çš„${SECRET_NAME}å€¼"
                  exit 1 
                fi
              elif [[ "$SECRET_NAME" == "PREFIX" ]]; then
                if [[ -n "${{ secrets.PREFIX }}" ]]; then
                  echo "ä½¿ç”¨GitHubä¸­é…ç½®çš„PREFIXå€¼"
                  SECRET_VALUE="${{ secrets.PREFIX }}"
                else
                  echo "âŒ æœªæ‰¾åˆ°GitHubä¸­é…ç½®çš„${SECRET_NAME}å€¼"
                  exit 1 
                fi
              fi
              
              set +e
              echo "æ­£åœ¨è®¾ç½®${SECRET_NAME}..."
              SECRET_PUT_OUTPUT=$(echo "$SECRET_VALUE" | npx wrangler secret put "$SECRET_NAME" 2>&1)
              SECRET_RESULT=$?
              set -e

              echo "Secret put è¾“å‡º:"
              echo "$SECRET_PUT_OUTPUT" | grep -v "Please update to the latest version"

              if [ $SECRET_RESULT -ne 0 ]; then
                # å¦‚æœé”™è¯¯æ˜¯ç”±äºå¯†é’¥å·²å­˜åœ¨å¯¼è‡´çš„ï¼Œè§†ä¸ºæˆåŠŸ
                if echo "$SECRET_PUT_OUTPUT" | grep -q -E "(already in use|already exists|conflict)"; then
                  echo "âš ï¸ ${SECRET_NAME}å·²å­˜åœ¨äºWorkerä¸­ä½†æœªè¢«åˆ—è¡¨å‘½ä»¤æ£€æµ‹åˆ°ï¼Œç»§ç»­æ‰§è¡Œ"
                else
                  # æœ€åå†æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦å› ä¸ºå¯†é’¥å·²å­˜åœ¨ä½†æœªè¢«æ­£ç¡®æ£€æµ‹
                  set +e
                  FINAL_CHECK=$(npx wrangler secret list 2>&1)
                  set -e

                  if echo "$FINAL_CHECK" | grep -q "$SECRET_NAME"; then
                    echo "è™½ç„¶è®¾ç½®${SECRET_NAME}å¤±è´¥ï¼Œä½†å¯†é’¥ä¼¼ä¹å·²å­˜åœ¨äºWorkerä¸­ï¼Œç»§ç»­æ‰§è¡Œ"
                  else
                    echo "âŒ è®¾ç½®${SECRET_NAME}å¤±è´¥ï¼Œä¸”å¯†é’¥ç¡®å®ä¸å­˜åœ¨ï¼Œé€€å‡ºéƒ¨ç½²"
                    echo "è¯¦ç»†é”™è¯¯ä¿¡æ¯: $SECRET_PUT_OUTPUT"
                    exit 1
                  fi
                fi
              else
                echo "âœ… ${SECRET_NAME} å·²æˆåŠŸåˆ›å»º(ä½œä¸ºsecretå˜é‡)"
              fi
            fi
            echo ""  # ç©ºè¡Œåˆ†éš”ä¸åŒå¯†é’¥çš„å¤„ç†æ—¥å¿—
          done
          
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          npx wrangler deploy 2>&1 | sed -E 's/https:\/\/[a-zA-Z0-9.-]*\.(workers|pages)\.dev/https:\/\/[REDACTED].\1.dev/g'

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ æˆåŠŸéƒ¨ç½²ï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          fi

