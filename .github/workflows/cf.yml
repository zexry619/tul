name: Deploy to Cloudflare Workers

on:
  workflow_dispatch:

  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - name: Install wrangler
        run: |
          npm install -g wrangler
          npx wrangler telemetry disable

      - name: Update environments
        run: |
          echo "æ£€æŸ¥é…ç½®æƒ…å†µ..."
          if grep -q "PASSWORD =" wrangler.toml; then
            echo "âš ï¸ æ£€æµ‹åˆ° wrangler.toml ä¸­å­˜åœ¨ç¡¬ç¼–ç çš„ PASSWORD, å°†ä»wrangler.tomlä¸­ç§»é™¤ç¡¬ç¼–ç "
            sed -i '/PASSWORD =/d' wrangler.toml
          fi 

          if grep -q "PREFIX =" wrangler.toml; then
            echo "âš ï¸ æ£€æµ‹åˆ°wrangler.tomlä¸­å­˜åœ¨ç¡¬ç¼–ç çš„ PREFIX, å°†ä»wrangler.tomlä¸­ç§»é™¤ç¡¬ç¼–ç "
            sed -i '/PREFIX =/d' wrangler.toml
          fi
          
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          npx wrangler deploy 2>&1 | sed -E 's/https:\/\/[a-zA-Z0-9.-]*\.(workers|pages)\.dev/https:\/\/[REDACTED].\1.dev/g'

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ æˆåŠŸéƒ¨ç½²ï¼"
            echo "===================================================="
            echo "åç»­æ­¥éª¤ï¼š"
            echo "1. è®¿é—® cloudflare.com, è¿›å…¥ Workers é¡µé¢"
            echo "2. è®¾ç½® worker ç¯å¢ƒå˜é‡"
            echo "3. åˆ›å»º PASSWORD å’Œ PREFIX ç¯å¢ƒå˜é‡å¹¶é‡æ–°éƒ¨ç½², å¦‚å·²å­˜åœ¨åˆ™å¿½ç•¥æ­¤æ­¥éª¤"
            echo "===================================================="
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          fi

